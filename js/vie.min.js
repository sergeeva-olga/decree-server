/* VIE.js 2.2.0 - Semantic Interaction Toolkit
by Henri Bergius and the IKS Project. Available under the MIT license.
See http://viejs.org for more information
*/!function(){var a=this,b=a.jQuery,c=a.Backbone,d=a._,e=a.VIE=function(a){this.config=a?a:{},this.services={},this.jQuery=b,this.entities=new this.Collection([],{vie:this}),this.Entity.prototype.entities=this.entities,this.Entity.prototype.entityCollection=this.Collection,this.Entity.prototype.vie=this,this.Namespaces.prototype.vie=this,this.namespaces=new this.Namespaces(this.config.baseNamespace?this.config.baseNamespace:"http://viejs.org/ns/",{owl:"http://www.w3.org/2002/07/owl#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",schema:"http://schema.org/",foaf:"http://xmlns.com/foaf/0.1/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",skos:"http://www.w3.org/2004/02/skos/core#",xsd:"http://www.w3.org/2001/XMLSchema#",sioc:"http://rdfs.org/sioc/ns#",dcterms:"http://purl.org/dc/terms/"}),this.Type.prototype.vie=this,this.Types.prototype.vie=this,this.Attribute.prototype.vie=this,this.Attributes.prototype.vie=this,this.types=new this.Types,this.types.add("owl:Thing"),this.config.classic===!0&&(this.RDFa=new this.ClassicRDFa(this),this.RDFaEntities=new this.ClassicRDFaEntities(this),this.EntityManager=new this.ClassicEntityManager(this),this.cleanup=function(){this.entities.reset()})};if(e.prototype.use=function(a,b){if(!b&&!a.name)throw new Error("Please provide a name for the service!");return a.vie=this,a.name=b?b:a.name,a.init&&a.init(),this.services[a.name]=a,this},e.prototype.service=function(a){if(!this.hasService(a))throw"Undefined service "+a;return this.services[a]},e.prototype.hasService=function(a){return!!this.services[a]},e.prototype.getServicesArray=function(){return d.map(this.services,function(a){return a})},e.prototype.load=function(a){return a||(a={}),a.vie=this,new this.Loadable(a)},e.prototype.save=function(a){return a||(a={}),a.vie=this,new this.Savable(a)},e.prototype.remove=function(a){return a||(a={}),a.vie=this,new this.Removable(a)},e.prototype.analyze=function(a){return a||(a={}),a.vie=this,new this.Analyzable(a)},e.prototype.find=function(a){return a||(a={}),a.vie=this,new this.Findable(a)},e.prototype.loadSchema=function(a,c){if(c=c?c:{},!a)throw new Error("Please provide a proper URL");var d=this;return b.getJSON(a).success(function(a){try{e.Util.loadSchemaOrg(d,a,c.baseNS),c.success&&c.success.call(d)}catch(a){return void c.error.call(d,a)}}).error(function(b,e,f){c.error&&c.error.call(d,"Could not load schema from URL ("+a+"): "+e)}),this},e.prototype.getTypedEntityClass=function(a){if(!this.types.get(a))throw new Error("Unknown type "+a);return this.typeEntityClasses[a.id]||(this.typeEntityClasses[a.id]=this.Entity.extend({defaults:{"@type":a}})),this.typeEntityClasses[a.id]},e.prototype.typeEntityClasses={},"object"==typeof exports&&(exports.VIE=e,b||(b=require("jquery")(require("jsdom").jsdom().defaultView)),c||(c=require("backbone"),c.$=b),d||(d=require("underscore")._)),e.prototype.Able=function(){this.init=function(a,c){return this.options=a,this.services=a.from||a.using||a.to||[],this.vie=a.vie,this.methodName=c,this.deferred=b.Deferred(),this.resolve=this.deferred.resolve,this.resolveWith=this.deferred.resolveWith,this.reject=this.deferred.reject,this.rejectWith=this.deferred.rejectWith,this.success=this.done=this.deferred.done,this.fail=this.deferred.fail,this.then=this.deferred.then,this.always=this.deferred.always,this.from=this.using,this.to=this.using,this},this.using=function(a){var b=this;return a=d.isArray(a)?a:[a],d.each(a,function(a){var c="string"==typeof a?b.vie.service(a):a;b.services.push(c)}),this},this.execute=function(){var a=this;return d(this.services).each(function(b){b[a.methodName](a)}),this}},e.prototype.Loadable=function(a){this.init(a,"load")},e.prototype.Loadable.prototype=new e.prototype.Able,e.prototype.Savable=function(a){this.init(a,"save")},e.prototype.Savable.prototype=new e.prototype.Able,e.prototype.Removable=function(a){this.init(a,"remove")},e.prototype.Removable.prototype=new e.prototype.Able,e.prototype.Analyzable=function(a){this.init(a,"analyze")},e.prototype.Analyzable.prototype=new e.prototype.Able,e.prototype.Findable=function(a){this.init(a,"find")},e.prototype.Findable.prototype=new e.prototype.Able,e.Util={isReference:function(a){return!!new RegExp("^\\<([^\\>]*)\\>$").exec(a)},toReference:function(a,b){if(d.isArray(a))return d.map(a,function(a){return this.toReference(a)},this);if(!d.isString(a))return a;var c=a;return"_:"===a.substring(0,2)?c=a:b&&b.isCurie(a)?(c=b.uri(a))==="<"+b.base()+a+">"&&(c="<"+a+">"):b&&!b.isUri(a)&&(c="<"+a+">"),c},fromReference:function(a,b){return b&&!b.isUri(a)?a:a.substring(1,a.length-1)},toCurie:function(a,b,c){if(e.Util.isCurie(a,c))return a;var d=":";for(var f in c.toObj())if(1===a.indexOf(c.get(f))){var g=new RegExp("^<?"+c.get(f));return""===f&&(d=""),(b?"[":"")+a.replace(g,f+d).replace(/>$/,"")+(b?"]":"")}throw new Error("No prefix found for URI '"+a+"'!")},isCurie:function(a,b){if(e.Util.isUri(a))return!1;try{return e.Util.toUri(a,b),!0}catch(a){return!1}},toUri:function(a,b){if(e.Util.isUri(a))return a;for(var c in b.toObj())if(""!==c&&(0===a.indexOf(c+":")||0===a.indexOf("["+c+":"))){var d=new RegExp("^\\[{0,1}"+c+":");return"<"+a.replace(d,b.get(c)).replace(/\]{0,1}$/,"")+">"}if(a.indexOf(":")===-1)return"<"+b.base()+a+">";throw new Error("No prefix found for CURIE '"+a+"'!")},isUri:function(a){return"string"==typeof a&&0===a.search(/^<.+>$/)},mapAttributeNS:function(a,b){var c=a;return b.isUri(a)||0===a.indexOf("@")||(b.isCurie(a)?c=b.uri(a):b.isUri(a)||(c=a.indexOf(":")===-1?"<"+b.base()+a+">":"<"+a+">")),c},rdf2Entities:function(a,c){if("function"!=typeof b.rdf)return e.Util._rdf2EntitiesNoRdfQuery(a,c);var f={};try{b.typedValue.types["http://www.w3.org/2001/XMLSchema#gYear"]={regex:/^-?([0-9]{4,}).*$/,validate:function(a){return 0!==parseInt(a,10)},strip:!0,value:function(a){return parseInt(a,10)}};var g;if(c instanceof b.rdf?g=c.base(a.vie.namespaces.base()):(g=b.rdf(),g.base(a.vie.namespaces.base()),g.load(c,{})),a.rules){var h=b.rdf.ruleset();for(var i in a.vie.namespaces.toObj())""!==i&&h.prefix(i,a.vie.namespaces.get(i));for(var j=0;j<a.rules.length;j++)if(a.rules.hasOwnProperty(j)){var k=a.rules[j];h.add(k.left,k.right)}g=g.reason(h,10)}g.where("?subject ?property ?object").each(function(){var b=this.subject.toString();f[b]||(f[b]={"@subject":b,"@context":a.vie.namespaces.toObj(!0),"@type":[]});var c,d=this.property.toString();try{c=a.vie.namespaces.curie(d)}catch(a){c=d}f[b][c]=f[b][c]||[],f[b][c].push(function(a){if("string"==typeof a.value){if(a.lang){return{toString:function(){return this["@value"]},"@value":a.value.replace(/^"|"$/g,""),"@language":a.lang}}return a.value}return"uri"===a.type?a.toString():a.value}(this.object))}),d(f).each(function(a){a["@type"]=a["@type"].concat(a["rdf:type"]),delete a["rdf:type"],d(a).each(function(b,c){1===b.length&&(a[c]=b[0])})})}catch(a){return[]}var l=[];return b.each(f,function(){try{var b=new a.vie.Entity(this);l.push(b)}catch(a){}}),l},getPreferredLangForPreferredProperty:function(a,b,c){var e,f,g;return f=[],d.each(c,function(c,h){d.each(b,function(b,h){e=null,"string"==typeof b&&a.get(b)?(e=d.flatten([a.get(b)]),d(e).each(function(a){var b,d,e,g;return e=g=0,b=a["@language"],"string"!=typeof a||a.indexOf("@")!==a.length-3&&a.indexOf("@")!==a.length-5||(b=a.replace(/(^\"*|\"*@)..(..)?$/g,"")),e+=b?b===c?g:20:10,d=a.toString(),d=d.replace(/(^\"*|\"*@..$)/g,""),f.push({score:e,value:d})})):"object"==typeof b&&a.get(b.property)&&(g=d.flatten([a.get(b.property)]),g=d(g).map(function(a){return a.isEntity?a.getSubject():a}),f.push({score:h,value:b.makeLabel(g)}))})}),f=d(f).sortBy(function(a){return a.score}),f.length?f[0].value:"n/a"},_rdf2EntitiesNoRdfQuery:function(a,b){var c=[];return d.forEach(b,function(a,b){var e={};e["@subject"]="<"+b+">",d.forEach(a,function(a,b){b="<"+b+">",d.forEach(a,function(a){if("uri"===a.type&&(a.value="<"+a.value+">"),e[b]&&!d.isArray(e[b])&&(e[b]=[e[b]]),d.isArray(e[b]))return void e[b].push(a.value);e[b]=a.value})}),c.push(e)}),c},loadSchemaOrg:function(a,b,c){if(!b)throw new Error("Please load the schema.json file.");a.types.remove("<http://schema.org/Thing>");var e=c?c:a.namespaces.base();a.namespaces.base(c);var f={DataType:"xsd:anyType",Boolean:"xsd:boolean",Date:"xsd:date",DateTime:"xsd:dateTime",Time:"xsd:time",Float:"xsd:float",Integer:"xsd:integer",Number:"xsd:anySimpleType",Text:"xsd:string",URL:"xsd:anyURI"},g=function(c,d){for(var e=a.types.add(d,[{id:"value",range:f[d]}]),h=0;h<c.length;h++){var i=a.types.get(c[h])?a.types.get(c[h]):g.call(a,b.datatypes[c[h]].supertypes,c[h]);e.inherit(i)}return e};for(var h in b.datatypes)if(!a.types.get(h)){var i=b.datatypes[h].supertypes;g.call(a,i,h)}var j=function(a){var b={};return a.label&&(b.label=a.label),a.url&&(b.url=a.url),a.comment&&(b.comment=a.comment),a.metadata&&(b=d.extend(b,a.metadata)),b},k=function(a){var c=[];return d.each(b.types[a].specific_properties,function(a){var d=b.properties[a];c.push({id:d.id,range:d.ranges,min:d.min,max:d.max,metadata:j(d)})}),c},l=function(c,d,e,f){for(var g=a.types.add(d,e,f),h=0;h<c.length;h++){var i=a.types.get(c[h])?a.types.get(c[h]):l.call(a,b.types[c[h]].supertypes,c[h],k.call(a,c[h]),j(b.types[c[h]]));g.inherit(i)}return"Thing"!==d||g.isof("owl:Thing")||g.inherit("owl:Thing"),g};d.each(b.types,function(b){if(!a.types.get(b.id)){var c=b.supertypes,d=j(b);l.call(a,c,b.id,k.call(a,b.id),d)}}),a.namespaces.base(e)},getEntityTypeUnion:function(a){return new a.vie.Type("Union").inherit(a.get("@type"))},getFormSchemaForType:function(a,b){var c={};return d.each(a.attributes.toArray(),function(a){var b=e.Util.toCurie(a.id,!1,a.vie.namespaces);c[b]=e.Util.getFormSchemaForAttribute(a)}),d.each(c,function(a,d){a.type||delete c[d],"URL"===a.type&&(a.type="Text",a.dataType="url"),"List"!==a.type||a.listType||delete c[d],b||"NestedModel"!==a.type&&"NestedModel"!==a.listType||delete c[d]}),c},getFormSchemaForAttribute:function(a){var b=a.range[0],c={},d=function(b){switch(b){case"xsd:anySimpleType":case"xsd:float":case"xsd:integer":return"Number";case"xsd:string":return"Text";case"xsd:date":return"Date";case"xsd:dateTime":return"DateTime";case"xsd:boolean":return"Checkbox";case"xsd:anyURI":return"URL";default:var c=a.vie.types.get(b);return c?c.attributes.get("value")?d(c.attributes.get("value").range[0]):"NestedModel":null}};return c.title=e.Util.toCurie(a.id,!1,a.vie.namespaces),a.min>0&&(c.validators=["required"]),a.max>1?(c.type="List",c.listType=d(b),"NestedModel"===c.listType&&(c.nestedModelType=b),c):(c.type=d(b),"NestedModel"===c.type&&(c.nestedModelType=b),c)},getFormSchema:function(a){if(!a||!a.isEntity)return{};var b=e.Util.getEntityTypeUnion(a),c=e.Util.getFormSchemaForType(b,!0);return d.each(c,function(b,d){"NestedModel"!==b.type&&"NestedModel"!==b.listType||(c[d].model=a.vie.getTypedEntityClass(b.nestedModelType))}),c},xsdDateTime:function(a){function b(a){var b=a.toString();return b.length<2?"0"+b:b}return a.getFullYear()+"-"+b(a.getMonth()+1)+"-"+b(a.getDate())+"T"+b(a.getHours())+":"+b(a.getMinutes())+":"+b(a.getSeconds())},extractLanguageString:function(a,b,c){var f,g,h,i,j;if(a&&"string"!=typeof a){for(b=d.isArray(b)?b:[b],c=d.isArray(c)?c:[c],f=0;f<b.length;f++)for(var k=0;k<c.length;k++){var l=c[k];if(g=b[f],a.has(g))for(h=a.get(g),h=d.isArray(h)?h:[h],i=0;i<h.length;i++)if(j=h[i],(j=j.isEntity?e.Util.extractLanguageString(j,b,l):"string"==typeof j?j:"")&&j.indexOf("@"+l)>-1)return j.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}for(f=0;f<b.length;f++)if(g=b[f],a.has(g))for(h=a.get(g),h=d.isArray(h)?h:[h],i=0;i<h.length;i++)if(j=h[i],j.isEntity&&(j=e.Util.extractLanguageString(j,b,[])),j&&"string"==typeof j&&j.indexOf("@")===-1)return j.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}},transformationRules:function(a){return[{left:["?subject a dbpedia:Person","?subject rdfs:label ?label"],right:function(a){return function(){return[b.rdf.triple(this.subject.toString(),"a","<"+a.base()+"Person>",{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"name>",this.label,{namespaces:a.toObj()})]}}(a.vie.namespaces)},{left:["?subject a foaf:Person","?subject rdfs:label ?label"],right:function(a){return function(){return[b.rdf.triple(this.subject.toString(),"a","<"+a.base()+"Person>",{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"name>",this.label,{namespaces:a.toObj()})]}}(a.vie.namespaces)},{left:["?subject a dbpedia:Place","?subject rdfs:label ?label"],right:function(a){return function(){return[b.rdf.triple(this.subject.toString(),"a","<"+a.base()+"Place>",{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"name>",this.label.toString(),{namespaces:a.toObj()})]}}(a.vie.namespaces)},{left:["?subject a dbpedia:City","?subject rdfs:label ?label","?subject dbpedia:abstract ?abs","?subject dbpedia:country ?country"],right:function(a){return function(){return[b.rdf.triple(this.subject.toString(),"a","<"+a.base()+"City>",{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"name>",this.label.toString(),{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"description>",this.abs.toString(),{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"containedIn>",this.country.toString(),{namespaces:a.toObj()})]}}(a.vie.namespaces)}]},getAdditionalRules:function(a){var c={Work:"CreativeWork",Film:"Movie",TelevisionEpisode:"TVEpisode",TelevisionShow:"TVSeries",Website:"WebPage",Painting:"Painting",Sculpture:"Sculpture",Event:"Event",SportsEvent:"SportsEvent",MusicFestival:"Festival",FilmFestival:"Festival",Place:"Place",Continent:"Continent",Country:"Country",City:"City",Airport:"Airport",Station:"TrainStation",Hospital:"GovernmentBuilding",Mountain:"Mountain",BodyOfWater:"BodyOfWater",Company:"Organization",Person:"Person"},e=[];return d.each(c,function(c,d){var f={left:["?subject a dbpedia:"+d,"?subject rdfs:label ?label"],right:function(a){return function(){return[b.rdf.triple(this.subject.toString(),"a","<"+a.base()+c+">",{namespaces:a.toObj()}),b.rdf.triple(this.subject.toString(),"<"+a.base()+"name>",this.label.toString(),{namespaces:a.toObj()})]}}(a.vie.namespaces)};e.push(f)}),e}},e.prototype.Entity=c.Model.extend({idAttribute:"@subject",isEntity:!0,defaults:{"@type":"owl:Thing"},initialize:function(a,b){return a||(a={}),b||(b={}),a["@subject"]?this.id=this["@subject"]=this.toReference(a["@subject"]):this.id=this["@subject"]=a["@subject"]=this.cid.replace("c","_:bnode"),this},schema:function(){return e.Util.getFormSchema(this)},get:function(a){a=e.Util.mapAttributeNS(a,this.vie.namespaces);var b=c.Model.prototype.get.call(this,a);if(b=d.isArray(b)?b:[b],0!==b.length)return b=d.map(b,function(b){return void 0!==b&&"@type"===a?(this.vie.types.get(b)||this.vie.types.add(b).inherit("owl:Thing"),this.vie.types.get(b)):void 0!==b&&this.vie.entities.get(b)?this.vie.entities.get(b):b},this),b=1===b.length?b[0]:b},has:function(a){return a=e.Util.mapAttributeNS(a,this.vie.namespaces),c.Model.prototype.has.call(this,a)},hasRelations:function(){var a=!1;return d.each(this.attributes,function(b){b&&b.isCollection&&(a=!0)}),a},set:function(a,b,f){if(!a)return this;if(a["@subject"]&&(a["@subject"]=this.toReference(a["@subject"])),d.isString(a)){var g={};return g[a]=b,this.set(g,f)}b||(b={}),b.validate!==!1&&b.silent!==!0&&(b.validate=!0),a.attributes&&(a=a.attributes);var h;d.each(a,function(b,c){var d=e.Util.mapAttributeNS(c,this.vie.namespaces);c!==d&&(delete a[c],a[d]=b)},this),d.each(a,function(c,e){if(c&&e.indexOf("@")===-1)if(c.isCollection)c.each(function(a){this.vie.entities.addOrUpdate(a)},this);else if(c.isEntity)this.vie.entities.addOrUpdate(c),h=new this.vie.Collection(c,{vie:this.vie,predicate:e}),a[e]=h;else if(d.isArray(c)){if(this.attributes[e]&&this.attributes[e].isCollection){var f=this.attributes[e].addOrUpdate(c);a[e]=this.attributes[e],a[e].reset(f)}}else if(c["@value"]);else if(d.isObject(c)&&!d.isDate(c)){var g=new this.vie.Entity(c,b);this.vie.entities.addOrUpdate(g),h=new this.vie.Collection(c,{vie:this.vie,predicate:e}),a[e]=h}},this);var i=c.Model.prototype.set.call(this,a,b);return b&&b.ignoreChanges&&(this.changed={},this._previousAttributes=d.clone(this.attributes)),i},unset:function(a,b){return a=e.Util.mapAttributeNS(a,this.vie.namespaces),c.Model.prototype.unset.call(this,a,b)},validate:function(a,b){if(!b||b.validate!==!1){var c=this.get("@type");if(c){if(d.isArray(c)){var e=[];if(d.each(c,function(c){var d=this.validateByType(c,a,b);d&&e.push(d)},this),d.isEmpty(e))return;return d.flatten(e)}return this.validateByType(c,a,b)}}},validateByType:function(a,b,c){var e={max:"<%= property %> cannot contain more than <%= num %> items",min:"<%= property %> must contain at least <%= num %> items",required:"<%= property %> is required"};if(a.attributes){var f=function(a,b,c){return{property:a.id,constraint:b,message:d.template(e[b],d.extend({property:a.id},c))}},g=function(a,b){if(!b[a.id]||d.isEmpty(b[a.id]))return f(a,"required",{})},h=function(a,b){if(b&&b[a.id]&&(b[a.id].isCollection||d.isArray(b[a.id])))return b[a.id].length>a.max?f(a,"max",{num:a.max}):void 0},i=[];if(d.each(a.attributes.list(),function(a){var c;a.max&&a.max!=-1&&(c=h(a,b))&&i.push(c),a.min&&a.min>0&&(c=g(a,b))&&i.push(c)}),!d.isEmpty(i))return i}},isNew:function(){return"_:bnode"===this.getSubjectUri().substr(0,7)},hasChanged:function(a){return!!this.markedChanged||c.Model.prototype.hasChanged.call(this,a)},forceChanged:function(a){this.markedChanged=!!a},getSubject:function(){return void 0===this.id&&(this.id=this.attributes[this.idAttribute]),"string"==typeof this.id?"http://"===this.id.substr(0,7)||"urn:"===this.id.substr(0,4)?this.toReference(this.id):this.id:this.cid.replace("c","_:bnode")},getSubjectUri:function(){return this.fromReference(this.getSubject())},isReference:function(a){return e.Util.isReference(a)},toReference:function(a){return e.Util.toReference(a,this.vie.namespaces)},fromReference:function(a){return e.Util.fromReference(a,this.vie.namespaces)},as:function(a){if("JSON"===a)return this.toJSON();if("JSONLD"===a)return this.toJSONLD();throw new Error("Unknown encoding "+a)},toJSONLD:function(){var a={};return d.each(this.attributes,function(b,c){var e=this.get(c);b instanceof this.vie.Collection&&(e=b.map(function(a){return a.getSubject()})),"@type"===c&&(e=d.isArray(e)?d.map(e,function(a){return a.toString()}):e.toString()),a[c]=e},this),a["@subject"]=this.getSubject(),a},setOrAdd:function(a,b,c){return d.isString(a)&&b?this._setOrAddOne(a,b,c):d.isObject(a)&&d.each(a,function(a,c){this._setOrAddOne(c,a,b)},this),this},_setOrAddOne:function(a,b,f){if(a&&b){if(f=f?f:{},a=e.Util.mapAttributeNS(a,this.vie.namespaces),d.isArray(b))return void d.each(b,function(c){this._setOrAddOne(a,b[c],f)},this);"@type"===a&&b instanceof this.vie.Type&&(b=b.id);var g={},h=c.Model.prototype.get.call(this,a);if(h)if(h.isCollection){if(b.isCollection)b.each(function(a){h.add(a)});else if(b.isEntity)h.add(b);else{if(!d.isObject(b))throw new Error("you cannot add a literal to a collection of entities!");b=new this.vie.Entity(b),h.add(b)}this.trigger("change:"+a,this,b,{})}else{if(!d.isArray(h)){var i=[h];return i.push(b),g[a]=i,this.set(g,f)}if(b.isCollection)b.each(function(c){this._setOrAddOne(a,b.at(c).getSubject(),f)},this);else if(b.isEntity)this._setOrAddOne(a,b.getSubject(),f);else if(d.isObject(b))b=new this.vie.Entity(b),this._setOrAddOne(a,b,f);else{var j=h.slice(0);j.push(b),this.set(a,j)}}else g[a]=b,this.set(g,f)}},hasType:function(a){return a=this.vie.types.get(a),this.hasPropertyValue("@type",a)},hasPropertyValue:function(a,b){var c=this.get(a);return d.isObject(b)||(b=this.vie.entities.get(b)),d.isArray(c)?c.indexOf(b)!==-1:c===b},isof:function(a){var b=this.get("@type");if(void 0===b)return!1;b=d.isArray(b)?b:[b],a=this.vie.types.get(a)?this.vie.types.get(a):new this.vie.Type(a);var c=!1;return d.each(b,function(b){this.vie.types.get(b).isof(a)&&(c=!0)},this),c},addTo:function(a,b){if(a instanceof this.vie.Collection)return b?a.addOrUpdate(this):a.add(this),this;throw new Error("Please provide a proper collection of type VIE.Collection as argument!")}}),e.prototype.Collection=c.Collection.extend({model:e.prototype.Entity,initialize:function(a,b){if(!b||!b.vie)throw new Error("Each collection needs a VIE reference");this.vie=b.vie,this.predicate=b.predicate},canAdd:function(a){return!0},get:function(a){return null!==a&&a?(a=a.getSubject?a.getSubject():a,"string"==typeof a&&0===a.indexOf("_:")?2===a.indexOf("bnode")?(a=a.replace("_:bnode","c"),this._byId[a]):this._byId["<"+a+">"]:this._byId[a]?this._byId[a]:(a=this.toReference(a),this._byId[a])):null},addOrUpdate:function(a,c){c=c||{};var e,f=this;if(d.isArray(a)){var g=[];return d.each(a,function(a){g.push(f.addOrUpdate(a,c))}),g}if(void 0===a)throw new Error("No model given");if(d.isString(a)&&(a={"@subject":a,id:a}),a.isEntity||(a=new this.model(a)),a.id&&this.get(a.id)&&(e=this.get(a.id)),this.get(a.cid)&&(e=this.get(a.cid)),e){var h={};return d.each(a.attributes,function(g,i){if(!e.has(i))return h[i]=g,!0;if("@subject"===i&&a.isNew()&&!e.isNew())return!0;if(e.get(i)===g)return!0;var j=e.attributes[i],k=g;return j instanceof f.vie.Collection||(c.overrideAttributes?(h[i]=g,!0):void("@context"===i?h[i]=b.extend(!0,{},j,k):(j=b.isArray(j)?j:[j],k=b.isArray(k)?k:[k],h[i]=d.uniq(j.concat(k)),h[i]=1===h[i].length?h[i][0]:h[i])))}),d.isEmpty(h)||e.set(h,c.updateOptions),e}return this.add(a,c.addOptions),a},isReference:function(a){return e.Util.isReference(a)},toReference:function(a){return e.Util.toReference(a,this.vie.namespaces)},fromReference:function(a){return e.Util.fromReference(a,this.vie.namespaces)},isCollection:!0}),e.prototype.Type=function(a,c,d){if(void 0===a||"string"!=typeof a)throw"The type constructor needs an 'id' of type string! E.g., 'Person'";if(this.id=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a),this.vie.types.get(this.id))throw new Error("The type "+this.id+" is already defined!");this.supertypes=new this.vie.Types,this.subtypes=new this.vie.Types,this.attributes=new this.vie.Attributes(this,c?c:[]),this.metadata=d?d:{},this.isof=function(a){if(a instanceof e.prototype.Type||(a=this.vie.types.get(a)?this.vie.types.get(a):new this.vie.Type(a)),a)return a.subsumes(this.id);throw new Error("No valid type given")},this.subsumes=function(a){if(a=this.vie.types.get(a)){if(this.id===a.id)return!0;for(var b=this.subtypes.list(),c=0;c<b.length;c++){var d=b[c];if(d&&(d.id===a.id||d.subsumes(a)))return!0}return!1}throw new Error("No valid type given")},this.inherit=function(a){if("string"==typeof a)this.inherit(this.vie.types.get(a));else if(a instanceof this.vie.Type){a.subtypes.addOrOverwrite(this),this.supertypes.addOrOverwrite(a);try{this.attributes.list()}catch(b){throw a.subtypes.remove(this),this.supertypes.remove(a),b}}else{if(!b.isArray(a))throw new Error("Wrong argument in VIE.Type.inherit()");for(var c=0,d=a.length;c<d;c++)this.inherit(a[c])}return this},this.hierarchy=function(){for(var a={id:this.id,subtypes:[]},b=this.subtypes.list(),c=0,d=b.length;c<d;c++){var e=this.vie.types.get(b[c]);a.subtypes.push(e.hierarchy())}return a},this.instance=function(a,b){return new(this.vie.getTypedEntityClass(this))(a,b)},this.toString=function(){return this.id}},e.prototype.Types=function(){this._types={},this.add=function(a,b,c){if(d.isArray(a))return d.each(a,function(a){this.add(a)},this),this;if(this.get(a))throw new Error("Type '"+a+"' already registered.");if("string"==typeof a){var e=new this.vie.Type(a,b,c);return this._types[e.id]=e,e}if(a instanceof this.vie.Type)return this._types[a.id]=a,a;throw new Error("Wrong argument to VIE.Types.add()!")},this.addOrOverwrite=function(a,b){return this.get(a)&&this.remove(a),this.add(a,b)},this.get=function(a){if(a){if("string"==typeof a){var b=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a);return this._types[b]}return a instanceof this.vie.Type?this.get(a.id):void 0}},this.remove=function(a){var b=this.get(a);if(!b)return this;if(!b||b.subsumes("owl:Thing"))return this;delete this._types[b.id];for(var c=b.subtypes.list(),d=0;d<c.length;d++){var e=c[d];1===e.supertypes.list().length?this.remove(e):e.supertypes.remove(b.id)}return b},this.toArray=this.list=function(){var a=[];for(var b in this._types)a.push(this._types[b]);return a},this.sort=function(a,c){var d=this;if(a=b.isArray(a)?a:[a],c=!!c,0===a.length)return[];var e,f,g=[a[0]];for(e=1,f=a.length;e<f;e++){var h=a[e],i=d.get(h);if(i)for(var j=0;j<g.length;j++){if(i.subsumes(g[j])){g.splice(j,0,h);break}j===g.length-1&&g.push(h)}}for(e=0;e<g.length;e++)g.lastIndexOf(g[e])!==e&&(g.splice(e,1),e--);return c||g.reverse(),g}},e.prototype.Attribute=function(a,b,c,e,f,g){if(void 0===a||"string"!=typeof a)throw new Error("The attribute constructor needs an 'id' of type string! E.g., 'Person'");if(void 0===b)throw new Error("The attribute constructor of "+a+" needs 'range'.");if(void 0===c)throw new Error("The attribute constructor of "+a+" needs a 'domain'.");this._domain=c,this.id=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a),this.range=d.isArray(b)?b:[b],e=e?e:0,this.min=e>0?e:0,f=f?f:1,f===-1&&(f=Number.MAX_VALUE),this.max=f>=this.min?f:this.min,this.metadata=g?g:{},this.applies=function(a){this.vie.types.get(a)&&(a=this.vie.types.get(a));for(var b=0,c=this.range.length;b<c;b++){if(void 0===this.vie.types.get(this.range[b])&&"string"==typeof a){if(a===this.range[b])return!0}else if(a.isof(this.range[b]))return!0}return!1}},e.prototype.Attributes=function(a,c){this._local={},this._attributes={},this.domain=a,this.add=function(a,b,c,e,f){if(d.isArray(a))return d.each(a,function(a){this.add(a)},this),this;if(this.get(a))throw new Error("Attribute '"+a+"' already registered for domain "+this.domain.id+"!");if("string"==typeof a){var g=new this.vie.Attribute(a,b,this.domain,c,e,f);return this._local[g.id]=g,g}if(a instanceof this.vie.Attribute)return a.domain=this.domain,a.vie=this.vie,this._local[a.id]=a,a;throw new Error("Wrong argument to VIE.Types.add()!")},this.remove=function(a){var b=this.get(a);if(b.id in this._local)return delete this._local[b.id],b;throw new Error("The attribute "+a+" is inherited and cannot be removed from the domain "+this.domain.id+"!")},this.get=function(a){if("string"==typeof a){var b=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a);return this._inherit()._attributes[b]}if(a instanceof this.vie.Attribute)return this.get(a.id);throw new Error("Wrong argument in VIE.Attributes.get()")},this._inherit=function(){var a,c,e,f,g,h=b.extend(!0,{},this._local),i=d.map(this.domain.supertypes.list(),function(a){return a.attributes}),j={},k={};for(a=0,f=i.length;a<f;a++){var l=i[a].list();for(c=0,g=l.length;c<g;c++)(e=l[c].id)in h||(e in j||e in k?(k[e]||(k[e]={range:[],mins:[],maxs:[],metadatas:[]}),e in j&&(k[e].range=b.merge(k[e].range,j[e].range),k[e].mins=b.merge(k[e].mins,[j[e].min]),k[e].maxs=b.merge(k[e].maxs,[j[e].max]),k[e].metadatas=b.merge(k[e].metadatas,[j[e].metadata]),delete j[e]),k[e].range=b.merge(k[e].range,l[c].range),k[e].mins=b.merge(k[e].mins,[l[c].min]),k[e].maxs=b.merge(k[e].maxs,[l[c].max]),k[e].metadatas=b.merge(k[e].metadatas,[l[c].metadata]),k[e].range=d.uniq(k[e].range),k[e].mins=d.uniq(k[e].mins),k[e].maxs=d.uniq(k[e].maxs),k[e].metadatas=d.uniq(k[e].metadatas)):j[e]=l[c])}b.extend(h,j);for(e in k){for(var m=k[e].range,n=k[e].mins,o=k[e].maxs,p=k[e].metadatas,q=[],r=0,s=m.length;r<s;r++){var t=this.vie.types.get(m[r]),u=!1;if(t)for(c=0;c<s;c++)if(c!==r){var v=this.vie.types.get(m[c]);if(v&&v.isof(t)){u=!0;break}}u||q.push(m[r])}var w=d.max(n),x=d.min(o);if(!(w<=x&&x>=0&&w>=0))throw new Error("This inheritance is not allowed because of an invalid minCount/maxCount pair!");h[e]=new this.vie.Attribute(e,q,this,w,x,p[0])}return this._attributes=h,this},this.toArray=this.list=function(a){var b=[],c=this._inherit()._attributes;for(var d in c)a&&!c[d].applies(a)||b.push(c[d]);return b},c=d.isArray(c)?c:[c],d.each(c,function(a){this.add(a.id,a.range,a.min,a.max,a.metadata)},this)},e.prototype.Namespaces)throw new Error("ERROR: VIE.Namespaces is already defined. Please check your VIE installation!");e.prototype.Namespaces=function(a,b){if(!a)throw new Error("Please provide a base namespace!");if(this._base=a,this._namespaces=b?b:{},"object"!=typeof this._namespaces||d.isArray(this._namespaces))throw new Error("If you want to initialise VIE namespace prefixes, please provide a proper object!")},e.prototype.Namespaces.prototype.base=function(a){if(a){if("string"==typeof a)return this.removeNamespace(a),this._base=a,this._base;throw new Error("Please provide a valid namespace!")}return this._base},e.prototype.Namespaces.prototype.add=function(a,b){if("object"==typeof a){for(var c in a)this.add(c,a[c]);return this}if(""===a)return this.base(b),this;if(this.contains(a)&&b!==this._namespaces[a])throw new Error("ERROR: Trying to register namespace prefix mapping ("+a+","+b+")!There is already a mapping existing: '("+a+","+this.get(a)+")'!");return this._namespaces[a]=b,this},e.prototype.Namespaces.prototype.addOrReplace=function(a,b){if("object"==typeof a){for(var c in a)this.addOrReplace(c,a[c]);return this}return this.remove(a),this.add(a,b)},e.prototype.Namespaces.prototype.get=function(a){return""===a?this.base():this._namespaces[a]},e.prototype.Namespaces.prototype.getPrefix=function(a){var c;return 0===a.indexOf("<")&&(a=a.substring(1,a.length-1)),b.each(this._namespaces,function(b,d){0===a.indexOf(d)&&(c=b),0===a.indexOf(b+":")&&(c=b)}),c},e.prototype.Namespaces.prototype.contains=function(a){return a in this._namespaces},e.prototype.Namespaces.prototype.containsNamespace=function(a){return void 0!==this.getPrefix(a)},e.prototype.Namespaces.prototype.update=function(a,b){return this.remove(a),this.add(a,b)},e.prototype.Namespaces.prototype.updateNamespace=function(a,b){return this.removeNamespace(a),this.add(a,b)},e.prototype.Namespaces.prototype.remove=function(a){return a&&delete this._namespaces[a],this},e.prototype.Namespaces.prototype.removeNamespace=function(a){var b=this.getPrefix(a);return b&&delete this._namespaces[b],this},e.prototype.Namespaces.prototype.toObj=function(a){return a?b.extend({},this._namespaces):b.extend({"":this._base},this._namespaces)},e.prototype.Namespaces.prototype.curie=function(a,b){return e.Util.toCurie(a,b,this)},e.prototype.Namespaces.prototype.isCurie=function(a){return e.Util.isCurie(a,this)},e.prototype.Namespaces.prototype.uri=function(a){return e.Util.toUri(a,this)},e.prototype.Namespaces.prototype.isUri=e.Util.isUri,e.prototype.ClassicRDFa=function(a){this.vie=a},e.prototype.ClassicRDFa.prototype={readEntities:function(a){var b=[],c=this.vie.RDFaEntities.getInstances(a);return d.each(c,function(a){b.push(a.toJSONLD())}),b},findPredicateElements:function(a,b,c){return this.vie.services.rdfa.findPredicateElements(a,b,c)},getPredicate:function(a){return this.vie.services.rdfa.getElementPredicate(a)},getSubject:function(a){return this.vie.services.rdfa.getElementSubject(a)}},e.prototype.ClassicRDFaEntities=function(a){this.vie=a},e.prototype.ClassicRDFaEntities.prototype={getInstances:function(a){this.vie.services.rdfa||this.vie.use(new this.vie.RdfaService);var b=null,c=!1;for(this.vie.load({element:a}).from("rdfa").execute().done(function(a){b=a,c=!0});!c;);return b},getInstance:function(a){var b=this.getInstances(a);return b&&b.length?b.pop():null}},e.prototype.ClassicEntityManager=function(a){this.vie=a,this.entities=this.vie.entities},e.prototype.ClassicEntityManager.prototype={getBySubject:function(a){return this.vie.entities.get(a)},getByJSONLD:function(a){if("string"==typeof a)try{a=b.parseJSON(a)}catch(a){return null}return this.vie.entities.addOrUpdate(a)},initializeCollection:function(){}},function(){e.prototype.DBPediaService=function(a){
var c={name:"dbpedia",namespaces:{owl:"http://www.w3.org/2002/07/owl#",yago:"http://dbpedia.org/class/yago/",foaf:"http://xmlns.com/foaf/0.1/",georss:"http://www.georss.org/georss/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",dcelements:"http://purl.org/dc/elements/1.1/"},rules:[]};this.options=b.extend(!0,c,a?a:{}),this.vie=null,this.name=this.options.name,b.ajaxSetup({converters:{"text application/rdf+json":function(a){return JSON.parse(a)}},timeout:6e4})},e.prototype.DBPediaService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}return this.rules=b.extend([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[]),this.connector=new this.vie.DBPediaConnector(this.options),this},load:function(a){var b=this;if(!(a instanceof this.vie.Loadable))throw new Error("Invalid Loadable passed");var c=function(c){c="string"==typeof c?JSON.parse(c):c,d.defer(function(){try{var f=e.Util.rdf2Entities(b,c);f=d.isArray(f)?f:[f],d.each(f,function(a){a.set("DBPediaServiceLoad",e.Util.xsdDateTime(new Date))}),f=1===f.length?f[0]:f,a.resolve(f)}catch(b){a.reject(b)}})},f=function(b,c,d){a.reject(d)},g=a.options.entity?a.options.entity:a.options.entities;if(g){g=d.isArray(g)?g:[g];for(var h=[],i=0;i<g.length;i++){var j="string"==typeof g[i]?g[i]:g[i].id;h.push(j)}this.connector.load(h,c,f)}else a.reject([]);return this}},e.prototype.DBPediaConnector=function(a){this.options=a,this.baseUrl="http://dbpedia.org/sparql?default-graph-uri=http%3A%2F%2Fdbpedia.org&timeout=0"},e.prototype.DBPediaConnector.prototype={load:function(a,c,e,f){f||(f={});var g=this.baseUrl+"&format="+encodeURIComponent("application/rdf+json")+"&query=";if(d.isArray(a)){for(var h="",i="",j=0;j<a.length;j++){var k=/^<.+>$/.test(a[j])?a[j]:"<"+a[j]+">";j>0&&(h+=" .",i+=" UNION "),h+=" "+k+" ?prop"+j+" ?val"+j,i+=" { "+k+" ?prop"+j+" ?val"+j+" }"}g+=encodeURIComponent("CONSTRUCT {"+h+" } WHERE {"+i+" }")}else a=/^<.+>$/.test(a)?a:"<"+a+">",g+=encodeURIComponent("CONSTRUCT { "+a+" ?prop ?val } WHERE { "+a+" ?prop ?val }");var l=f.format||"application/rdf+json";return"undefined"!=typeof exports&&"undefined"!=typeof process?this._loadNode(g,c,e,f,l):(b.ajax({success:function(a){c(a)},converters:{"text json":function(a){var b=new RegExp("\\U0","g");return JSON.parse(a.replace(b,"\\u0"))}},error:e,type:"GET",url:g,accepts:{"application/rdf+json":"application/rdf+json"}}),this)},_loadNode:function(a,b,c,d,e){return require("request")({method:"GET",uri:a,headers:{Accept:e}},function(a,d,e){if(200!==d.statusCode)return c(e);b(JSON.parse(e))}).end(),this}}}(),function(){e.prototype.OpenCalaisService=function(a){var c={name:"opencalais",url:["http://api.opencalais.com/enlighten/rest/"],timeout:6e4,namespaces:{opencalaisc:"http://s.opencalais.com/1/pred/",opencalaiscr:"http://s.opencalais.com/1/type/er/",opencalaiscm:"http://s.opencalais.com/1/type/em/e/"},rules:[]};this.options=b.extend(!0,c,a?a:{}),this.vie=null,this.name=this.options.name,b.ajaxSetup({converters:{"text application/rdf+json":function(a){return JSON.parse(a)}},timeout:this.options.timeout})},e.prototype.OpenCalaisService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}this.rules=b.extend([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[]),this.connector=new this.vie.OpenCalaisConnector(this.options)},analyze:function(a){var c=this;if(!(a instanceof this.vie.Analyzable))throw"Invalid Analyzable passed";var f=a.options.element?a.options.element:b("body"),g=c._extractText(f);if(g.length>0){var h=function(b){d.defer(function(){var d=e.Util.rdf2Entities(c,b);a.resolve(d)})},i=function(b){a.reject(b)};this.connector.analyze(g,h,i)}else console.warn("No text found in element."),a.resolve([])},_extractText:function(a){if(a.get(0)&&a.get(0).tagName&&("TEXTAREA"==a.get(0).tagName||"INPUT"==a.get(0).tagName&&a.attr("type","text")))return a.get(0).val();var c=a.text().replace(/\s+/g," ").replace(/\0\b\n\r\f\t/g,"");return b.trim(c)}},e.prototype.OpenCalaisConnector=function(a){this.options=a,this.baseUrl=d.isArray(a.url)?a.url:[a.url],this.enhancerUrlPrefix="/"},e.prototype.OpenCalaisConnector.prototype={analyze:function(a,c,e,f){if(f||(f={urlIndex:0}),f.urlIndex>=this.baseUrl.length)return void e("Could not connect to the given OpenCalais endpoints! Please check for their setup!");var g=this.baseUrl[f.urlIndex].replace(/\/$/,"");g+=this.enhancerUrlPrefix;var h=f.format||"application/rdf+json",i=function(a,b,c,e,f){return function(){console.error("OpenCalais connection error",arguments),a.analyze(b,c,e,d.extend(f,{urlIndex:f.urlIndex+1}))}}(this,a,c,e,f),j=this._prepareData(a);if("undefined"!=typeof exports&&"undefined"!=typeof process)return this._analyzeNode(g,j,c,i,f,h);b.ajax({success:function(a,b,d){var e=d.responseText.replace(/<!--[\s\S]*?-->/g,"");c(e)},error:i,type:"POST",url:g,data:j,accept:"text/plain"})},_analyzeNode:function(a,b,c,d,e,f){require("request")({method:"POST",uri:a,body:b,headers:{Accept:f}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},_prepareData:function(a){return{licenseID:this.options.api_key,calculareRelevanceScore:"true",enableMetadataType:"GenericRelations,SocialTags",contentType:"text/html",content:a}}}}(),function(){e.prototype.RdfaRdfQueryService=function(a){var c={name:"rdfardfquery",namespaces:{},rules:[]};this.options=b.extend(!0,c,a?a:{}),this.views=[],this.vie=null,this.name=this.options.name},e.prototype.RdfaRdfQueryService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}this.rules=b.extend([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[])},analyze:function(a){return this.load(a)},load:function(a){var c=this;if(!(a instanceof this.vie.Loadable||a instanceof this.vie.Analyzable))throw new Error("Invalid Loadable/Analyzable passed");var d=a.options.element?a.options.element:b(document);try{var f=b(d).find("[about],[typeof]").rdfa();b.each(b(d).xmlns(),function(a,b){c.vie.namespaces.addOrReplace(a,b.toString())});var g=e.Util.rdf2Entities(this,f);a.resolve(g)}catch(b){a.reject(b)}},save:function(a){a instanceof this.vie.Savable||a.reject("Invalid Savable passed"),a.options.element||a.reject("Unable to write entity to RDFa, no element given"),a.options.entity||a.reject("Unable to write to RDFa, no entity given"),b.rdf||a.reject("No rdfQuery found.");var c=a.options.entity,d=[],e=c.get("@type");e=b.isArray(e)?e[0]:e,e=e.id,d.push(c.getSubject()+" a "+e),b(a.options.element).rdfa(d),a.resolve()}}}(),function(){e.prototype.RdfaService=function(a){var c={name:"rdfa",namespaces:{},subjectSelector:"[about],[typeof],[src],html",predicateSelector:"[property],[rel]",rules:[],bnodePrefix:"_a"};this.options=b.extend(!0,c,a?a:{}),this.bnodes=0,this.views=[],this.templates={},this.datatypeReaders={"<http://www.w3.org/2001/XMLSchema#boolean>":function(a){return"true"===a||1===a||a===!0},"<http://www.w3.org/2001/XMLSchema#dateTime>":function(a){return new Date(a)},"<http://www.w3.org/2001/XMLSchema#integer>":function(a){return parseInt(a,10)}},this.datatypeWriters={"<http://www.w3.org/2001/XMLSchema#dateTime>":function(a){return d.isDate(a)?a.toISOString():a}},this.vie=null,this.name=this.options.name},e.prototype.RdfaService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}this.rules=b.merge([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[])},analyze:function(a){return this.load(a)},load:function(a){if(!(a instanceof this.vie.Loadable||a instanceof this.vie.Analyzable))throw new Error("Invalid Loadable/Analyzable passed");var c;if(a.options.element)c=a.options.element;else{if("undefined"==typeof document)return a.resolve([]);c=b(document)}var d=this.readEntities(c);a.resolve(d)},save:function(a){if(!(a instanceof this.vie.Savable))throw"Invalid Savable passed";if(!a.options.element)throw"Unable to write entity to RDFa, no element given";if(!a.options.entity)throw"Unable to write to RDFa, no entity given";this._writeEntity(a.options.entity,a.options.element),a.resolve()},readEntities:function(a){var c=this,d=[];b(this.options.subjectSelector,a).add(b(a).filter(this.options.subjectSelector)).each(function(){var a=c.xmlns(this);for(var e in a)c.vie.namespaces.addOrReplace(e,a[e]);var f=c._readEntity(b(this));f&&d.push(f)});return d},_readEntity:function(a){var c=this.getElementSubject(a),e=this._getElementType(a),f=this._readEntityPredicates(c,a,!1);if(b.isEmptyObject(f))return null;var g=this.vie;d.each(f,function(a,b){if(d.isArray(a)){var c=new this.vie.Collection([],{vie:g,predicate:b});d.each(a,function(a){var b=g.entities.addOrUpdate({"@subject":a});c.addOrUpdate(b)}),f[b]=c}},this),f["@subject"]=c,e&&(f["@type"]=e);var h=new this.vie.Entity(f);return h=this.vie.entities.addOrUpdate(h,{updateOptions:{silent:!0,ignoreChanges:!0}}),this._registerEntityView(h,a),h},_writeEntity:function(a,c){var d=this;return this.findPredicateElements(this.getElementSubject(c),c,!0).each(function(){var c=b(this),e=d.getElementPredicate(c);if(!a.has(e))return!0;var f=a.get(e);return!(!f||!f.isCollection)||(f===d.readElementValue(e,c)||void d.writeElementValue(e,c,f))}),!0},_getViewForElement:function(a,c){var d;return b.each(this.views,function(){if(b(this.el).get(0)===a.get(0))return!(!c||this.template)||(d=this,!1)}),d},_registerEntityView:function(a,c,d){if(c.length){var e=this,f=this._getViewForElement(c);return f?(a.hasRelations()&&!f.collectionsChecked&&this._registerEntityCollectionViews(a,c,f),f):(f=new this.vie.view.Entity({model:a,el:c,tagName:c.get(0).nodeName,vie:this.vie,service:this.name}),this.views.push(f),d&&b(c).find(this.options.predicateSelector).add(b(c).filter(this.options.predicateSelector)).each(function(){var c=b(this).attr("rel");c&&a.set(c,new e.vie.Collection([],{vie:e.vie,predicate:c}))}),this._registerEntityCollectionViews(a,c,f),f)}},_registerEntityCollectionViews:function(a,c,e){var f=this;d.each(a.attributes,function(d,g){var h=a.fromReference(a.get(g));h&&h.isCollection&&(b.each(f.getElementByPredicate(g,c),function(){f._registerCollectionView(h,b(this),a)}),e.collectionsChecked=!0)})},setTemplate:function(a,b,c){var e;c||(c=b,b="default"),a=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a),e=d.isFunction(c)?c:this.getElementTemplate(c),this.templates[a]||(this.templates[a]={}),this.templates[a][b]=e,d.each(this.views,function(c){c instanceof this.vie.view.Collection&&c.collection.predicate===b&&(c.templates[a]=e)},this)},getTemplate:function(a,b){if(b||(b="default"),a=this.vie.namespaces.isUri(a)?a:this.vie.namespaces.uri(a),this.templates[a])return this.templates[a][b]},_getElementTemplates:function(a,c,e){var f={},g=c.get("@type");if(g&&g.attributes&&g.attributes.get(e)){var h=g.attributes.get(e);if(d.each(h.range,function(a){var b=this.getTemplate(a,e);if(b){var c=this.vie.types.get(a);f[c.id]=b}},this),!d.isEmpty(f))return f}var i=this;if(b("[typeof]",a).each(function(){var a=b(this),c=a.attr("typeof");if(c=i.vie.namespaces.isUri(c)?c:i.vie.namespaces.uri(c),!f[c]){var d=i.getElementTemplate(a);f[c]=d,f["<http://www.w3.org/2002/07/owl#Thing>"]=d}}),d.isEmpty(f)){var j=a.children(":first-child");j.length&&(f["<http://www.w3.org/2002/07/owl#Thing>"]=i.getElementTemplate(j))}return f},getElementTemplate:function(a){d.isString(a)&&(a=b.trim(a));var c=this;return function(d,e){var f=b(a).clone(!1);void 0!==f.attr("about")&&f.attr("about",""),f.find("[about]").attr("about","");var g=c.findPredicateElements(g,f,!1).each(function(){var a=b(this),e=c.getElementPredicate(a);if(d.has(e)&&d.get(e).isCollection)return!0;c.writeElementValue(null,a,"")});e(f)}},_registerCollectionView:function(a,b,c){var d=this._getViewForElement(b,!0);return d?d:(d=new this.vie.view.Collection({owner:c,collection:a,model:a.model,el:b,templates:this._getElementTemplates(b,c,a.predicate),service:this}),this.views.push(d),d)},_getElementType:function(a){var c;return b(a).attr("typeof")!==this.options.attributeExistenceComparator?(c=b(a).attr("typeof"),c&&c.indexOf("://")!==-1?"<"+c+">":c):null},_generatebnodeId:function(){var a=this.options.bnodePrefix+":"+this.bnodes;return this.bnodes++,a},getElementSubject:function(a,c){var d=this;if("undefined"!=typeof document&&a===document)return document.baseURI;var e,f=null;return b(a).closest(this.options.subjectSelector).each(function(){if(f=this,b(this).attr("about")!==d.options.attributeExistenceComparator)return e=b(this).attr("about"),!0;if(b(this).attr("src")!==d.options.attributeExistenceComparator)return e=b(this).attr("src"),!0;if(b(this).attr("typeof")!==d.options.attributeExistenceComparator){var a=b(this);return a.data("vie-bnode")?(e=a.data("vie-bnode"),!0):(e=d._generatebnodeId(),a.data("vie-bnode",e),!0)}"HTML"===b(this).get(0).nodeName&&b("base",this).each(function(){e=b(this).attr("href")})}),e?"object"==typeof e?e:0===e.indexOf("_:")?e:0===e.indexOf("<")?e:"<"+e+">":void 0},setElementSubject:function(a,c){return b(c).attr("src")?b(c).attr("src",a):b(c).attr("about",a)},getElementPredicate:function(a){var c;return a=b(a),c=a.attr("property"),c||(c=a.attr("rel")),c},getElementBySubject:function(a,c){var d=this;return b(c).find(this.options.subjectSelector).add(b(c).filter(this.options.subjectSelector)).filter(function(){return d.getElementSubject(b(this))===a})},getElementByPredicate:function(a,c){var d=this,e=this.getElementSubject(c);return b(c).find(this.options.predicateSelector).add(b(c).filter(this.options.predicateSelector)).filter(function(){var c=d.getElementPredicate(b(this));return d.vie.namespaces.curie(c)===d.vie.namespaces.curie(a)&&d.getElementSubject(this)===e})},_readEntityPredicates:function(a,c,d){var e=this,f={};return this.findPredicateElements(a,c,!0).each(function(){var a=b(this),c=e.getElementPredicate(a);if(""!==c){var g=e.readElementValue(c,a);(null!==g||d)&&(f[c]=g)}}),"HTML"!==b(c).get(0).tagName&&b(c).parent("[rev]").each(function(){b(this).attr("rev")&&(f[b(this).attr("rev")]=e.getElementSubject(this))}),f},findSubjectElements:function(a){return b("[about]",a)},findPredicateElements:function(a,c,d){var e=this;return b(c).find(this.options.predicateSelector).add(b(c).filter(this.options.predicateSelector)).filter(function(){return e.getElementSubject(this)===a&&(!!d||!b(this).parents("[property]").length)})},parseElementValue:function(a,b){if(!b.attr("datatype"))return a;var c=this.vie.namespaces.uri(b.attr("datatype"));return this.datatypeReaders[c]?this.datatypeReaders[c](a):a},generateElementValue:function(a,b){if(!b.attr("datatype"))return a;var c=this.vie.namespaces.uri(b.attr("datatype"));return this.datatypeWriters[c]?this.datatypeWriters[c](a):a},readElementValue:function(a,c){var d=c.attr("content");if(d)return this.parseElementValue(d,c);var e=c.attr("resource");if(e)return["<"+e+">"];var f=c.attr("href");if(f&&c.attr("rel")===a)return["<"+f+">"];if(c.attr("rel")){var g=[],h=this;return b(c).children(this.options.subjectSelector).each(function(){g.push(h.getElementSubject(this,!0))}),g}return this.parseElementValue(c.html(),c)},writeElementValue:function(a,b,c){if(c=this.generateElementValue(c,b),d.isArray(c)&&c.length>0&&(c=c[0]),b.attr("content"))return void b.attr("content",c);b.attr("resource")&&b.attr("resource",c),b.html(c)},xmlns:function(a){var c;if(a)c=b(a);else{if("undefined"==typeof document)return{};c=b(document)}c=c.add(c.parents());var d={};return c.each(function(){for(var a=this,b=0;b<a.attributes.length;b+=1){var c=a.attributes[b];if(/^xmlns(:(.+))?$/.test(c.nodeName)){var e=/^xmlns(:(.+))?$/.exec(c.nodeName)[2]||"",f=c.value;""!==e&&""===f||(d[e]=c.value)}}}),d}}}(),function(){var a=["http://demo.iks-project.eu/stanbolfull","http://dev.iks-project.eu/stanbolfull"];e.prototype.StanbolService=function(c){var d={name:"stanbol",url:a,timeout:2e4,namespaces:{semdeski:"http://www.semanticdesktop.org/ontologies/2007/01/19/nie#",semdeskf:"http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#",skos:"http://www.w3.org/2004/02/skos/core#",foaf:"http://xmlns.com/foaf/0.1/",opengis:"http://www.opengis.net/gml/",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",owl:"http://www.w3.org/2002/07/owl#",geonames:"http://www.geonames.org/ontology#",enhancer:"http://fise.iks-project.eu/ontology/",entityhub:"http://www.iks-project.eu/ontology/rick/model/",entityhub2:"http://www.iks-project.eu/ontology/rick/query/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",dcterms:"http://purl.org/dc/terms/",schema:"http://schema.org/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#"},rules:[{left:["?subject a <http://fise.iks-project.eu/ontology/EntityAnnotation>","?subject enhancer:entity-type ?type","?subject enhancer:confidence ?confidence","?subject enhancer:entity-reference ?entity","?subject dcterms:relation ?relation","?relation a <http://fise.iks-project.eu/ontology/TextAnnotation>","?relation enhancer:selected-text ?selected-text","?relation enhancer:selection-context ?selection-context","?relation enhancer:start ?start","?relation enhancer:end ?end"],right:["?entity a ?type","?entity enhancer:hasTextAnnotation ?relation","?entity enhancer:hasEntityAnnotation ?subject"]}],enhancer:{chain:"default"},entityhub:{site:void 0}};this.options=b.extend(!0,d,c?c:{}),this.vie=null,this.name=this.options.name},e.prototype.StanbolService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}this.rules=b.extend([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[]),this.connector=new this.vie.StanbolConnector(this.options),this.vie.types.addOrOverwrite("enhancer:EntityAnnotation",[]).inherit("owl:Thing"),this.vie.types.addOrOverwrite("enhancer:TextAnnotation",[]).inherit("owl:Thing"),this.vie.types.addOrOverwrite("enhancer:Enhancement",[]).inherit("owl:Thing")},analyze:function(a){var c=this;if(!(a instanceof this.vie.Analyzable))throw"Invalid Analyzable passed";var f=a.options.element?a.options.element:b("body"),g=c._extractText(f);if(g.length>0){var h=function(b){d.defer(function(){var d=e.Util.rdf2Entities(c,b);c.vie.entities.addOrUpdate(d),a.resolve(d)})},i=function(b){a.reject(b)},j={chain:a.options.chain?a.options.chain:c.options.enhancer.chain};this.connector.analyze(g,h,i,j)}else a.resolve([])},find:function(a){if(!(a instanceof this.vie.Findable))throw"Invalid Findable passed";var b=this;a.options.term||a.reject([]);var c=a.options.term,f=void 0===a.options.limit?20:a.options.limit,g=void 0===a.options.offset?0:a.options.offset,h=function(c){d.defer(function(){var d=e.Util.rdf2Entities(b,c);a.resolve(d)})},i=function(b){a.reject(b)};a.options.site=a.options.site?a.options.site:b.options.entityhub.site;var j=this.vie;if(a.options.properties){var k=a.options.properties;a.options.ldPath=d(k).map(function(a){return j.namespaces.isCurie(a)?j.namespaces.uri(a)+";":a}).join("")}if(a.options.field&&j.namespaces.isCurie(a.options.field)){var l=a.options.field;a.options.field=j.namespaces.uri(l)}this.connector.find(c,f,g,h,i,a.options)},load:function(a){if(!(a instanceof this.vie.Loadable))throw"Invalid Loadable passed";var b=this,c=a.options.entity;c||a.resolve([]);var f=function(c){d.defer(function(){var f=e.Util.rdf2Entities(b,c);d.each(f,function(a){b.vie.entities.addOrUpdate(a)}),a.resolve(f)})},g=function(b){a.reject(b)},h={site:a.options.site?a.options.site:b.options.entityhub.site,local:a.options.local};this.connector.load(c,f,g,h)},save:function(a){if(!(a instanceof this.vie.Savable))throw"Invalid Savable passed";var b=this,c=a.options.entity;c||a.reject("StanbolConnector: No entity to save!");var f=function(c){d.defer(function(){var d=e.Util.rdf2Entities(b,c);a.resolve(d)})},g=function(b){a.reject(b)},h={site:a.options.site?a.options.site:b.options.entityhub.site,local:a.options.local};this.connector.save(c,f,g,h)},_extractText:function(a){if(a.get(0)&&a.get(0).tagName&&("TEXTAREA"==a.get(0).tagName||"INPUT"==a.get(0).tagName&&a.attr("type","text")))return a.get(0).val();var c=a.text().replace(/\s+/g," ").replace(/\0\b\n\r\f\t/g,"");return b.trim(c)}},e.prototype.StanbolConnector=function(c){var e={url:a,timeout:2e4,enhancer:{urlPostfix:"/enhancer",chain:"default"},entityhub:{site:void 0,urlPostfix:"/entityhub",local:!1},sparql:{urlPostfix:"/sparql"},contenthub:{urlPostfix:"/contenthub",index:"contenthub"},ontonet:{urlPostfix:"/ontonet"},factstore:{urlPostfix:"/factstore"},rules:{urlPostfix:"/rules"},cmsadapter:{urlPostfix:"/cmsadapter"}};this.options=b.extend(!0,e,c?c:{}),this.options.url=d.isArray(this.options.url)?this.options.url:[this.options.url],this._init(),this.baseUrl=d.isArray(c.url)?c.url:[c.url]},e.prototype.StanbolConnector.prototype={_init:function(){var a=this;return b.ajaxSetup({converters:{"text application/rdf+json":function(a){return JSON.parse(a)}},timeout:a.options.timeout}),this},_iterate:function(a){if(a){if(a.urlIndex>=this.options.url.length)return void a.error.call(this,"Could not connect to the given Stanbol endpoints! Please check for their setup!");var b=function(a,b){return function(){b.urlIndex=b.urlIndex+1,a._iterate(b)}}(this,a);return"undefined"!=typeof exports&&"undefined"!=typeof process?a.methodNode.call(this,a.url.call(this,a.urlIndex,a.args.options),a.args,a.success,b):a.method.call(this,a.url.call(this,a.urlIndex,a.args.options),a.args,a.success,b)}},analyze:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._analyze,methodNode:e._analyzeNode,url:function(a,b){var c=b.chain?b.chain:this.options.enhancer.chain,d=this.options.url[a].replace(/\/$/,"");return d+=this.options.enhancer.urlPostfix+"/chain/"+c.replace(/\/$/,"")},args:{text:a,format:d.format||"application/rdf+json",options:d},success:b,error:c,urlIndex:0})},_analyze:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:c.text,dataType:c.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_analyzeNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:b.text,headers:{Accept:b.format,"Content-Type":"text/plain"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},load:function(a,b,c,d){var e=this;d=d?d:{},d.uri=a.replace(/^</,"").replace(/>$/,""),e._iterate({method:e._load,methodNode:e._loadNode,success:b,error:c,url:function(a,b){var c=b.site?b.site:this.options.entityhub.site;c=c?"/"+c:"s";var d=b.local,e=this.options.url[a].replace(/\/$/,"")+this.options.entityhub.urlPostfix;return e+=d?"/entity?id="+encodeURIComponent(b.uri):"/site"+c+"/entity?id="+encodeURIComponent(b.uri)},args:{format:d.format||"application/rdf+json",options:d},urlIndex:0})},_load:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"GET",dataType:c.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_loadNode:function(a,b,c,d){require("request")({method:"GET",uri:a,body:b.text,headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},find:function(a,b,c,d,e,f){f=f?f:{};var g=this;if(!a||""===a)return void e("No term given!");c=c?c:0,b=b?b:10,g._iterate({method:g._find,methodNode:g._findNode,success:d,error:e,url:function(a,b){var c=b.site?b.site:this.options.entityhub.site;c=c?"/"+c:"s";var d=b.local,e=this.options.url[a].replace(/\/$/,"")+this.options.entityhub.urlPostfix;return e+=d?"/sites/find":"/site"+c+"/find"},args:{term:a,offset:c,limit:b,format:f.format||"application/rdf+json",options:f},urlIndex:0})},_find:function(a,c,d,e){var f={name:c.term,limit:c.limit,offset:c.offset};b.ajax({success:d,error:e,url:a,type:"POST",data:b.param(f),dataType:c.format,contentType:"application/x-www-form-urlencoded",accepts:{"application/rdf+json":"application/rdf+json"}})},_findNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:"name="+b.term+"&limit="+b.limit+"&offset="+b.offset,headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},lookup:function(a,b,c,d){d=d?d:{};var e=this;a=a.replace(/^</,"").replace(/>$/,""),d.uri=a,d.create=!!d.create&&d.create,e._iterate({method:e._lookup,methodNode:e._lookupNode,success:b,error:c,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"")+this.options.entityhub.urlPostfix;return c+="/lookup?id="+encodeURIComponent(b.uri)+"&create="+b.create},args:{format:d.format||"application/rdf+json",options:d},urlIndex:0})},_lookup:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"GET",dataType:c.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_lookupNode:function(a,b,c,d){require("request")({method:"GET",uri:a,body:b.text,headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},referenced:function(a,b,c){c=c?c:{};var e=this,f=function(b){d.isArray(b)||(b=JSON.parse(b));for(var c=[],e=0,f=b.length;e<f;e++)c.push(b[e].replace(/.+\/(.+?)\/?$/,"$1"));return a(c)};e._iterate({method:e._referenced,methodNode:e._referencedNode,success:f,error:b,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.entityhub.urlPostfix+"/sites/referenced"},args:{options:c},urlIndex:0})},_referenced:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"GET",accepts:{"application/rdf+json":"application/rdf+json"}})},_referencedNode:function(a,b,c,d){require("request")({method:"GET",uri:a,headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},sparql:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._sparql,methodNode:e._sparqlNode,success:b,error:c,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.sparql.urlPostfix.replace(/\/$/,"")},args:{query:a,options:d},urlIndex:0})},_sparql:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:"query="+c.query,contentType:"application/x-www-form-urlencoded"})},_sparqlNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:JSON.stringify({query:b.query}),headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},ldpath:function(a,b,c,e,f){f=f?f:{};var g=this;b=d.isArray(b)?b:[b];for(var h="",i=0;i<b.length;i++)h+="&context="+b[i];g._iterate({method:g._ldpath,methodNode:g._ldpathNode,success:c,error:e,url:function(a,b){var c=b.site?b.site:this.options.entityhub.site;c=c?"/"+c:"s";var d=b.local,e=this.options.url[a].replace(/\/$/,"")+this.options.entityhub.urlPostfix;return d||(e+="/site"+c),e+="/ldpath"},args:{ldpath:a,context:h,format:f.format||"application/rdf+json",options:f},urlIndex:0})},_ldpath:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:"ldpath="+c.ldpath+c.context,contentType:"application/x-www-form-urlencoded",dataType:c.format,accepts:{"application/rdf+json":"application/rdf+json"}})},_ldpathNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:"ldpath="+b.ldpath+b.context,headers:{Accept:b.format}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},uploadContent:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._uploadContent,methodNode:e._uploadContentNode,success:b,error:c,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.contenthub.urlPostfix.replace(/\/$/,""),c+="/"+(b.index?b.index:this.options.contenthub.index).replace(/\/$/,""),c+="/store"},args:{content:a,options:d},urlIndex:0})},_uploadContent:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:c.content,contentType:"text/plain"})},_uploadContentNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:b.content,headers:{Accept:"application/rdf+xml","Content-Type":"text/plain"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},createFactSchema:function(a,b,c,d,e){e=e?e:{};var f=this;e.url=a,f._iterate({method:f._createFactSchema,methodNode:f._createFactSchemaNode,success:c,error:d,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.factstore.urlPostfix.replace(/\/$/,""),c+="/facts/"+encodeURIComponent(b.url)},args:{url:a,schema:b,options:e},urlIndex:0})},_createFactSchema:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"PUT",data:c.schema,contentType:"application/json",dataType:"application/json"})},_createFactSchemaNode:function(a,b,c,d){require("request")({method:"PUT",uri:a,body:b.schema,headers:{Accept:"application/json","Content-Type":"application/json"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},createFact:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._createFact,methodNode:e._createFactNode,success:b,error:c,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.factstore.urlPostfix.replace(/\/$/,""),c+="/facts"},args:{fact:a,options:d},urlIndex:0})},_createFact:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:c.fact,contentType:"application/json",dataType:"application/json"})},_createFactNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:b.fact,headers:{Accept:"application/json","Content-Type":"application/json"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()},queryFact:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._queryFact,methodNode:e._queryFactNode,success:b,error:c,url:function(a,b){var c=this.options.url[a].replace(/\/$/,"");return c+=this.options.factstore.urlPostfix.replace(/\/$/,""),c+="/query"},args:{query:a,options:d},urlIndex:0})},_queryFact:function(a,c,d,e){b.ajax({success:d,error:e,url:a,type:"POST",data:c.query,contentType:"application/json",dataType:"application/json"})},_queryFactNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:b.query,headers:{Accept:"application/json","Content-Type":"application/json"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()}}}(),function(){e.prototype.ZemantaService=function(a){var c={name:"zemanta",url:["http://api.zemanta.com/services/rest/0.0/"],timeout:2e4,namespaces:{zemanta:"http://s.zemanta.com/ns#"},rules:[{left:["?subject a zemanta:Recognition","?subject zemanta:object ?object","?object owl:sameAs ?entity"],right:["?entity zemanta:hasEntityAnnotation ?subject"]}],api_key:void 0};this.options=b.extend(!0,c,a?a:{}),this.vie=null,this.name=this.options.name,b.ajaxSetup({converters:{"text application/rdf+json":function(a){return JSON.parse(a)}},timeout:this.options.timeout})},e.prototype.ZemantaService.prototype={init:function(){for(var a in this.options.namespaces){var c=this.options.namespaces[a];this.vie.namespaces.add(a,c)}this.rules=b.extend([],e.Util.transformationRules(this)),this.rules=b.merge(this.rules,this.options.rules?this.options.rules:[]),this.connector=new this.vie.ZemantaConnector(this.options),this.vie.types.addOrOverwrite("zemanta:Recognition",[]).inherit("owl:Thing")},analyze:function(a){var c=this;if(!(a instanceof this.vie.Analyzable))throw"Invalid Analyzable passed";var f=a.options.element?a.options.element:b("body"),g=c._extractText(f);if(g.length>0){var h=function(b){d.defer(function(){var d=e.Util.rdf2Entities(c,b);a.resolve(d)})},i=function(b){a.reject(b)},j={};this.connector.analyze(g,h,i,j)}else a.resolve([])},_extractText:function(a){return b(a).wrap("<div>").parent().html()}},e.prototype.ZemantaConnector=function(a){var c={url:["http://api.zemanta.com/services/rest/0.0/"],timeout:2e4,api_key:void 0}
;this.options=b.extend(!0,c,a?a:{}),this.options.url=d.isArray(this.options.url)?this.options.url:[this.options.url],this._init(),this.baseUrl=d.isArray(a.url)?a.url:[a.url]},e.prototype.ZemantaConnector.prototype={_init:function(){var a=this;return b.ajaxSetup({converters:{"text application/rdf+json":function(a){return JSON.parse(a)}},timeout:a.options.timeout}),this},_iterate:function(a){if(a){if(a.urlIndex>=this.options.url.length)return void a.error.call(this,"Could not connect to the given Zemanta endpoints! Please check for their setup!");var b=function(a,b){return function(){b.urlIndex=b.urlIndex+1,a._iterate(b)}}(this,a);return"undefined"!=typeof exports&&"undefined"!=typeof process?a.methodNode.call(this,a.url.call(this,a.urlIndex,a.args.options),a.args,a.success,b):a.method.call(this,a.url.call(this,a.urlIndex,a.args.options),a.args,a.success,b)}},analyze:function(a,b,c,d){d=d?d:{};var e=this;e._iterate({method:e._analyze,methodNode:e._analyzeNode,success:b,error:c,url:function(a,b){return this.options.url[a].replace(/\/$/,"")},args:{text:a,format:d.format||"rdfxml",options:d},urlIndex:0})},_analyze:function(a,c,d,e){b.ajax({success:function(a,b,c){var e=c.responseText.replace(/<z:signature>.*?<\/z:signature>/,"");d(e)},error:e,url:a,type:"POST",dataType:"xml",data:{method:"zemanta.suggest",text:c.text,format:c.format,api_key:this.options.api_key,return_rdf_links:c.options.return_rdf_links},contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_analyzeNode:function(a,b,c,d){require("request")({method:"POST",uri:a,body:b.text,headers:{Accept:b.format,"Content-Type":"text/plain"}},function(a,b,e){try{c({results:JSON.parse(e)})}catch(a){d(a)}}).end()}}}(),e.prototype.view||(e.prototype.view={}),e.prototype.view.Collection=c.View.extend({initialize:function(){if(this.templates=this.options.templates,this.service=this.options.service,!this.service)throw"No RDFa service provided to the Collection View";this.owner=this.options.owner,this.definition=this.options.definition,this.entityViews={},this.listenTo(this.collection,"add",this.addItem),this.listenTo(this.collection,"remove",this.removeItem),this.listenTo(this.collection,"reset",this.refreshItems),this.collection.each(function(a){this.registerItem(a,this.collection)},this)},canAdd:function(a){return!d.isEmpty(this.templates)&&(!(a&&!this.templates[a])&&this.collection.canAdd(a))},addItem:function(a,b){if(b===this.collection){var c,e=a.get("@type");if(d.isArray(e)?d.each(e,function(a){this.canAdd(a.id)&&(c=a.id)},this):this.canAdd(e.id)&&(c=e.id),c){var f=this;this.templates[c](a,function(c){var d=f.service._registerEntityView(a,c,!0),e=d.render().$el;a.id&&f.service.setElementSubject(a.getSubjectUri(),e);var g=b.indexOf(a);if(0===g)f.$el.prepend(e);else{var h=b.at(g-1),i=f.entityViews[h.cid];i?i.$el.after(e):f.$el.append(e)}f.findReverseRelations(a,e),f.trigger("add",d),f.entityViews[a.cid]=d,e.show()},this)}}},findReverseRelations:function(a,c){var d=this.service;c.parent("[rev]").each(function(){var c=b(this).attr("rev"),e={};e[c]=new d.vie.Collection([],{vie:d.vie,predicate:c});var f=d.vie.entities.get(d.getElementSubject(this));f&&e[c].addOrUpdate(f),a.set(e)})},registerItem:function(a,b){var c=this.service.getElementBySubject(a.id,this.el);if(c){var d=this.service._registerEntityView(a,c);this.entityViews[a.cid]=d}},removeItem:function(a){this.entityViews[a.cid]&&(this.trigger("remove",this.entityViews[a.cid]),b(this.entityViews[a.cid].el).remove(),delete this.entityViews[a.cid])},refreshItems:function(a){d.each(this.entityViews,function(a,c){b(a.el).remove()}),this.entityViews={},a.forEach(function(b){this.addItem(b,a)},this)}}),e.prototype.view||(e.prototype.view={}),e.prototype.view.Entity=c.View.extend({initialize:function(a){this.service=a.service?a.service:"rdfa",this.vie=a.vie,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:@subject",this.renderAbout)},render:function(){return this.vie.save({element:this.el,entity:this.model}).to(this.service).execute(),this},renderAbout:function(){this.vie.service(this.service).setElementSubject(this.model.getSubjectUri(),this.el)}});var a=this;!function(b){a.XDomainRequest&&b.ajaxTransport(function(a){if(a.crossDomain&&a.async){a.timeout&&(a.xdrTimeout=a.timeout,delete a.timeout);var c;return{send:function(d,e){function f(a,d,f,g){c.onload=c.onerror=c.ontimeout=b.noop,c=void 0,e(a,d,f,g)}if(c=new XDomainRequest,a.dataType){var g="header_Accept="+encodeURIComponent(a.dataType)+"&header_Content-Type=text/plain";a.url=a.url+(a.url.indexOf("?")===-1?"?":"&")+g}c.open(a.type,a.url),c.onload=function(a,b){f(200,"OK",{text:c.responseText},"Content-Type: "+c.contentType)},c.onerror=function(a){f(404,"Not Found")},a.xdrTimeout&&(c.ontimeout=function(){f(0,"timeout")},c.timeout=a.xdrTimeout),c.send(a.hasContent&&a.data||null)},abort:function(){c&&(c.onerror=b.noop(),c.abort())}}}})}(b)}();